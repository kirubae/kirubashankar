---
import '@styles/global.css';
import SEOHead from '@components/seo/SEOHead.astro';
import JsonLd from '@components/seo/JsonLd.astro';
import Header from '@components/layout/Header.astro';
import Footer from '@components/layout/Footer.astro';
import type { SEOProps } from '@types/index';

interface Props extends SEOProps {
  jsonLd?: Record<string, unknown> | Record<string, unknown>[];
  showNav?: boolean;
}

const { title, description, canonical, image, type, noindex, jsonLd, showNav } = Astro.props;

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || '';
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY || '';
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link rel="apple-touch-icon" href="/images/favicon.png" />

    <SEOHead
      title={title}
      description={description}
      canonical={canonical}
      image={image}
      type={type}
      noindex={noindex}
    />

    {jsonLd && <JsonLd schema={jsonLd} />}

    <!-- Preconnect to Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="min-h-screen flex flex-col bg-cream text-ink font-['Work_Sans',sans-serif]">
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <Header showNav={showNav} />
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    <Footer />

    <!-- Handle Supabase auth -->
    <script is:inline src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script is:inline define:vars={{ supabaseUrl, supabaseKey }}>
      (function() {
        if (!supabaseUrl || !supabaseKey) return;

        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Handle hash tokens from OAuth callback
        if (window.location.hash && window.location.hash.includes('access_token')) {
          supabase.auth.getSession().then(function(result) {
            if (result.data.session) {
              window.history.replaceState(null, '', window.location.pathname);
              window.location.reload();
            }
          });
          return;
        }

        // Update auth UI based on session
        supabase.auth.getSession().then(async function(result) {
          var authContainer = document.getElementById('auth-container');
          var tierBadge = document.getElementById('tier-badge');

          var session = result.data.session;
          if (session && session.user) {
            var user = session.user;
            var avatarUrl = user.user_metadata?.avatar_url || '';

            // Check localStorage cache for tier first
            var tier = 'free';
            var cached = localStorage.getItem('userTier');
            var cacheValid = false;
            if (cached) {
              try {
                var cacheData = JSON.parse(cached);
                // Cache valid for 5 minutes and same user
                if (cacheData.userId === user.id && Date.now() - cacheData.timestamp < 5 * 60 * 1000) {
                  tier = cacheData.tier;
                  cacheValid = true;
                }
              } catch (e) {}
            }

            // Fetch from DB if cache miss
            if (!cacheValid) {
              try {
                var profileResult = await supabase
                  .from('profiles')
                  .select('tier')
                  .eq('id', user.id)
                  .single();
                if (profileResult.data?.tier) {
                  tier = profileResult.data.tier;
                }
                // Cache the tier
                localStorage.setItem('userTier', JSON.stringify({
                  tier: tier,
                  userId: user.id,
                  timestamp: Date.now()
                }));
              } catch (e) {
                console.log('Could not fetch tier');
              }
            }

            // Show tier badge next to logo
            if (tierBadge) {
              var tierColors = {
                free: 'bg-gray-100 text-gray-600',
                pro: 'bg-amber-100 text-amber-700',
                enterprise: 'bg-purple-100 text-purple-700'
              };
              var tierLabel = tier.charAt(0).toUpperCase() + tier.slice(1);
              tierBadge.className = 'text-xs px-1.5 py-0.5 rounded ' + tierColors[tier];
              tierBadge.textContent = tierLabel;
            }

            // Update auth container with avatar and logout
            if (authContainer) {
              var html = '<div class="flex items-center gap-3">';
              if (avatarUrl) {
                html += '<img src="' + avatarUrl + '" alt="" class="w-7 h-7 rounded-full" />';
              }
              html += '<a href="/logout" class="text-ink-light hover:text-terracotta transition-colors">Logout</a>';
              html += '</div>';
              authContainer.innerHTML = html;
              authContainer.style.visibility = 'visible';
            }
          } else {
            // Not logged in - show login button
            if (authContainer) {
              authContainer.style.visibility = 'visible';
            }
            // Clear cached tier on logout
            localStorage.removeItem('userTier');
          }
        });
      })();
    </script>
  </body>
</html>
