---
import BaseLayout from '@layouts/BaseLayout.astro';
import '@styles/tools.css';

export const prerender = false;

const { id } = Astro.params;

// Fetch collection metadata (without sensitive data)
const { FILE_SHARE_DB } = Astro.locals.runtime.env;

interface CollectionInfo {
  id: string;
  title: string;
  subtitle: string | null;
  created_at: string;
  expires_at: string | null;
  has_password: number;
  has_email_restriction: number;
  item_count: number;
  depth: number;
}

interface BreadcrumbItem {
  id: string;
  title: string;
}

let collection: CollectionInfo | null = null;
let breadcrumbs: BreadcrumbItem[] = [];
let error: string | null = null;

try {
  collection = await FILE_SHARE_DB.prepare(`
    SELECT id, title, subtitle,
           created_at, expires_at, depth, item_count,
           CASE WHEN password_hash IS NOT NULL THEN 1 ELSE 0 END as has_password,
           CASE WHEN allowed_emails IS NOT NULL AND allowed_emails != '[]' THEN 1 ELSE 0 END as has_email_restriction
    FROM collections
    WHERE id = ? AND is_deleted = 0
  `).bind(id).first<CollectionInfo>();

  if (!collection) {
    error = 'Collection not found';
  } else if (collection.expires_at && new Date(collection.expires_at) < new Date()) {
    error = 'This collection has expired';
  } else {
    // Build breadcrumbs
    let currentId: string | null = id;
    while (currentId) {
      const item = await FILE_SHARE_DB.prepare(`
        SELECT id, title, parent_id FROM collections WHERE id = ? AND is_deleted = 0
      `).bind(currentId).first<{ id: string; title: string; parent_id: string | null }>();
      if (!item) break;
      breadcrumbs.unshift({ id: item.id, title: item.title });
      currentId = item.parent_id;
    }
  }
} catch (e) {
  error = 'Failed to load collection';
}
---

<BaseLayout
  title={collection ? collection.title : 'Collection Not Found'}
  description="View shared collection"
  noindex={true}
>
  <div class="collection-page">
    {error ? (
      <div class="error-container">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h2>{error}</h2>
        <p>The collection you're looking for is not available.</p>
        <a href="/" class="back-link">Go Home</a>
      </div>
    ) : (
      <>
        <!-- Access Form Section -->
        <section id="access-section" class="access-container">
          <div class="access-card">
            <div class="access-icon">
              <svg viewBox="0 0 24 24" fill="currentColor" width="56" height="56">
                <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
              </svg>
            </div>

            <h1 class="access-title">{collection.title}</h1>
            {collection.subtitle && <p class="access-subtitle">{collection.subtitle}</p>}
            <p class="access-meta">{collection.item_count} item{collection.item_count !== 1 ? 's' : ''}</p>

            <p class="access-help">
              Enter your email to access this collection.
              {collection.has_email_restriction ? ' Access is restricted to authorized emails.' : ''}
            </p>

            <form id="access-form">
              <input type="hidden" id="collection-id" value={id} />

              <div class="form-field">
                <input type="email" id="access-email" placeholder="Your email address" required />
              </div>

              {collection.has_password ? (
                <div class="form-field">
                  <input type="password" id="access-password" placeholder="Password" />
                </div>
              ) : null}

              <p id="access-error" class="access-error"></p>

              <button type="submit" id="btn-access" class="access-btn">
                Open
              </button>
            </form>
          </div>
        </section>

        <!-- Collection Viewer Section (hidden initially) -->
        <section id="viewer-section" class="viewer-container" style="display: none;">
          <!-- Header -->
          <header class="viewer-header">
            <nav id="breadcrumb-nav" class="breadcrumbs"></nav>
          </header>

          <!-- Contents -->
          <div class="viewer-content">
            <!-- Loading -->
            <div id="contents-loading" class="loading-state">
              <div class="loading-spinner"></div>
              <span>Loading...</span>
            </div>

            <!-- Empty -->
            <div id="contents-empty" class="empty-state" style="display:none;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
              </svg>
              <p>This folder is empty</p>
            </div>

            <!-- File List -->
            <div id="contents-list" class="file-list" style="display:none;"></div>
          </div>
        </section>
      </>
    )}
  </div>
</BaseLayout>

<style>
  .collection-page {
    min-height: 100vh;
    background: #f8f9fa;
  }

  /* Error State */
  .error-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 24px;
    text-align: center;
    color: #5f6368;
  }
  .error-container svg { color: #dadce0; margin-bottom: 16px; }
  .error-container h2 { font-size: 20px; font-weight: 500; color: #202124; margin: 0 0 8px; }
  .error-container p { margin: 0 0 24px; }
  .back-link { color: #1a73e8; text-decoration: none; font-weight: 500; }
  .back-link:hover { text-decoration: underline; }

  /* Access Form */
  .access-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 24px;
  }
  .access-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
    padding: 48px 40px;
    max-width: 400px;
    width: 100%;
    text-align: center;
  }
  .access-icon {
    color: #5f6368;
    margin-bottom: 16px;
  }
  .access-title {
    font-size: 22px;
    font-weight: 400;
    color: #202124;
    margin: 0 0 4px;
  }
  .access-subtitle {
    font-size: 14px;
    color: #5f6368;
    margin: 0 0 4px;
  }
  .access-meta {
    font-size: 13px;
    color: #80868b;
    margin: 0 0 20px;
  }
  .access-help {
    font-size: 14px;
    color: #5f6368;
    margin: 0 0 24px;
    line-height: 1.5;
  }
  #access-form { text-align: left; }
  .form-field { margin-bottom: 16px; }
  .form-field input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #dadce0;
    border-radius: 4px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  .form-field input:focus {
    border-color: #1a73e8;
    box-shadow: 0 0 0 2px rgba(26,115,232,0.1);
  }
  .access-error {
    color: #d93025;
    font-size: 13px;
    min-height: 20px;
    margin: 0 0 8px;
    text-align: center;
  }
  .access-btn {
    width: 100%;
    padding: 10px 24px;
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
  }
  .access-btn:hover { background: #1557b0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .access-btn:disabled { background: #80868b; cursor: not-allowed; }

  /* Viewer */
  .viewer-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 24px;
  }
  .viewer-header {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    padding: 16px 0;
    z-index: 10;
    border-bottom: 1px solid #e8eaed;
  }
  .breadcrumbs {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 14px;
    flex-wrap: wrap;
  }
  .breadcrumbs a {
    color: #5f6368;
    text-decoration: none;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background 0.15s;
  }
  .breadcrumbs a:hover { background: #e8eaed; color: #202124; }
  .breadcrumbs .sep { color: #80868b; font-size: 18px; }
  .breadcrumbs .current {
    color: #202124;
    font-weight: 500;
    padding: 4px 8px;
  }

  .viewer-content { padding: 16px 0 48px; }

  /* Loading & Empty States */
  .loading-state, .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 24px;
    color: #5f6368;
  }
  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e8eaed;
    border-top-color: #1a73e8;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 12px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .empty-state svg { color: #dadce0; margin-bottom: 12px; }
  .empty-state p { margin: 0; font-size: 14px; }

  /* File List - Google Drive Style */
  .file-list {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    overflow: hidden;
  }
  .file-row {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    border-bottom: 1px solid #f1f3f4;
    cursor: pointer;
    transition: background 0.1s;
  }
  .file-row:last-child { border-bottom: none; }
  .file-row:hover { background: #f8f9fa; }
  .file-row.folder:hover { background: #e8f0fe; }

  .file-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-right: 12px;
  }
  .file-icon.folder svg { color: #5f6368; }
  .file-icon.pdf svg { color: #ea4335; }
  .file-icon.doc svg { color: #4285f4; }
  .file-icon.sheet svg { color: #34a853; }
  .file-icon.image svg { color: #ea4335; }
  .file-icon.file svg { color: #5f6368; }

  .file-info {
    flex: 1;
    min-width: 0;
  }
  .file-name {
    font-size: 14px;
    color: #202124;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .file-meta {
    font-size: 12px;
    color: #80868b;
    margin-top: 2px;
  }

  .file-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.15s;
  }
  .file-row:hover .file-actions { opacity: 1; }

  .download-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    border-radius: 50%;
    cursor: pointer;
    color: #5f6368;
    transition: background 0.15s, color 0.15s;
  }
  .download-btn:hover {
    background: #e8eaed;
    color: #202124;
  }

  @media (max-width: 600px) {
    .access-card { padding: 32px 24px; }
    .viewer-container { padding: 0 16px; }
    .file-row { padding: 12px; }
    .file-actions { opacity: 1; }
  }
</style>

<script is:inline>
  const form = document.getElementById('access-form');
  if (form) {
    const btnAccess = document.getElementById('btn-access');
    const originalBtnText = btnAccess.textContent;

    // Token storage
    let accessToken = null;
    let accessTimestamp = null;
    let accessEmail = null;
    let rootCollectionId = null;

    // Format file size
    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Get file type class for icon color
    function getFileTypeClass(mimeType, filename) {
      const ext = filename.split('.').pop()?.toLowerCase();
      if (mimeType === 'application/pdf' || ext === 'pdf') return 'pdf';
      if (mimeType === 'text/csv' || ext === 'csv') return 'sheet';
      if (mimeType.includes('spreadsheet') || mimeType.includes('excel') || ext === 'xls' || ext === 'xlsx') return 'sheet';
      if (mimeType.includes('word') || ext === 'doc' || ext === 'docx') return 'doc';
      if (mimeType.startsWith('image/')) return 'image';
      return 'file';
    }

    // Get file icon SVG based on type
    function getFileIcon(type) {
      const icons = {
        folder: `<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>`,
        pdf: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 15h6M9 11h6"/></svg>`,
        doc: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
        sheet: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><line x1="12" y1="9" x2="12" y2="21"/></svg>`,
        image: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`,
        file: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="24" height="24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`
      };
      return icons[type] || icons.file;
    }

    // Download icon
    const downloadIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;

    // Build token params
    function getTokenParams() {
      return `token=${accessToken}&t=${accessTimestamp}&email=${encodeURIComponent(accessEmail)}&root=${rootCollectionId}`;
    }

    // Load collection contents
    async function loadContents(collectionId) {
      const loading = document.getElementById('contents-loading');
      const empty = document.getElementById('contents-empty');
      const list = document.getElementById('contents-list');

      loading.style.display = 'flex';
      empty.style.display = 'none';
      list.style.display = 'none';

      try {
        const response = await fetch(`/api/share/collections/${collectionId}/contents?${getTokenParams()}`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to load contents');
        }

        // Update breadcrumbs
        const breadcrumbNav = document.getElementById('breadcrumb-nav');
        breadcrumbNav.innerHTML = data.breadcrumbs.map((b, i) => {
          if (i === data.breadcrumbs.length - 1) {
            return `<span class="current">${b.title}</span>`;
          }
          return `<a href="javascript:void(0)" onclick="navigateToCollection('${b.id}')">${b.title}</a><span class="sep">â€º</span>`;
        }).join('');

        loading.style.display = 'none';

        if (data.children.length === 0) {
          empty.style.display = 'flex';
          return;
        }

        list.style.display = 'block';
        list.innerHTML = data.children.map(child => {
          if (child.type === 'collection') {
            return `
              <div class="file-row folder" onclick="navigateToCollection('${child.id}')">
                <div class="file-icon folder">${getFileIcon('folder')}</div>
                <div class="file-info">
                  <div class="file-name">${child.title}</div>
                  <div class="file-meta">${child.item_count} item${child.item_count !== 1 ? 's' : ''}</div>
                </div>
              </div>
            `;
          } else {
            const typeClass = getFileTypeClass(child.mime_type, child.filename);
            return `
              <div class="file-row" onclick="downloadFile(event, '${collectionId}', '${child.id}')">
                <div class="file-icon ${typeClass}">${getFileIcon(typeClass)}</div>
                <div class="file-info">
                  <div class="file-name">${child.filename}</div>
                  <div class="file-meta">${formatSize(child.file_size)}</div>
                </div>
                <div class="file-actions">
                  <button class="download-btn" title="Download">${downloadIcon}</button>
                </div>
              </div>
            `;
          }
        }).join('');

      } catch (error) {
        loading.innerHTML = `<span style="color:#d93025">${error.message || 'Failed to load contents'}</span>`;
      }
    }

    // Navigate to collection
    window.navigateToCollection = function(collectionId) {
      loadContents(collectionId);
    };

    // Download file
    window.downloadFile = function(event, collectionId, fileId) {
      event.stopPropagation();
      const url = `/api/share/collections/${collectionId}/download/${fileId}?${getTokenParams()}`;
      window.location.href = url;
    };

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const collectionId = document.getElementById('collection-id').value;
      const email = document.getElementById('access-email').value;
      const passwordInput = document.getElementById('access-password');
      const password = passwordInput ? passwordInput.value : null;
      const errorEl = document.getElementById('access-error');

      errorEl.textContent = '';
      btnAccess.disabled = true;
      btnAccess.textContent = 'Opening...';

      try {
        const response = await fetch(`/api/share/collections/${collectionId}/access`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          errorEl.textContent = data.error || 'Access denied';
          btnAccess.disabled = false;
          btnAccess.textContent = originalBtnText;
          return;
        }

        // Store access credentials
        accessToken = data.token;
        accessTimestamp = data.timestamp;
        accessEmail = data.email;
        rootCollectionId = data.root_collection_id;

        // Show viewer section
        document.getElementById('access-section').style.display = 'none';
        document.getElementById('viewer-section').style.display = 'block';

        // Load contents
        await loadContents(collectionId);

      } catch (err) {
        errorEl.textContent = 'An error occurred. Please try again.';
        btnAccess.disabled = false;
        btnAccess.textContent = originalBtnText;
      }
    });
  }
</script>
