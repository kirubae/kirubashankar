---
import BaseLayout from '@layouts/BaseLayout.astro';
import { generateBreadcrumbSchema } from '@components/seo/schemas/BreadcrumbSchema';
import { generateWebApplicationSchema } from '@components/seo/schemas/WebApplicationSchema';
import Breadcrumb from '@components/ui/Breadcrumb.astro';
import '@styles/tools.css';

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'My Tools', url: '/tools' },
  { name: 'VLOOKUP for Large Files', url: '/tools/data-merge' },
];

const jsonLdSchema = [
  generateBreadcrumbSchema(breadcrumbs),
  generateWebApplicationSchema({
    name: 'VLOOKUP for Large Files',
    description: 'Merge and join large datasets quickly. Replace Excel VLOOKUP with powerful join operations for files up to 500MB.',
    slug: 'data-merge',
    category: 'UtilityApplication',
    featureList: ['CSV and Excel support', 'Left, Right, Inner, Full joins', 'Handle 500MB+ files', 'Multiple files per side'],
  }),
];
---

<BaseLayout
  title="VLOOKUP for Large Files - Merge Datasets Online"
  description="Replace Excel VLOOKUP with powerful merge operations for large files. Support for CSV and Excel files up to 500MB, multiple join types, and handle multiple files at once."
  jsonLd={jsonLdSchema}
>
  <!-- Auth Modal -->
  <div class="auth-modal" id="auth-modal">
    <div class="auth-modal-content">
      <h2>Choose your mode</h2>
      <p class="auth-subtitle">Select how you want to use the merge tool</p>

      <div class="auth-options">
        <button class="auth-option" id="auth-guest">
          <div class="auth-option-icon guest">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </div>
          <div class="auth-option-text">
            <span class="auth-option-title">Guest</span>
            <span class="auth-option-desc">1 file per side, max 10MB each</span>
          </div>
        </button>

        <button class="auth-option" id="auth-password">
          <div class="auth-option-icon pro">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
          </div>
          <div class="auth-option-text">
            <span class="auth-option-title">Maker</span>
            <span class="auth-option-desc">Multiple files, up to 500MB each</span>
          </div>
        </button>
      </div>

      <div class="auth-password-form" id="auth-password-form" style="display: none;">
        <input type="password" id="auth-password-input" placeholder="Enter access password" />
        <div class="auth-password-actions">
          <button class="btn btn-secondary" id="auth-back">Back</button>
          <button class="btn btn-primary" id="auth-submit">Unlock</button>
        </div>
        <p class="auth-error" id="auth-error" style="display: none;">Incorrect password</p>
      </div>
    </div>
  </div>

  <div class="merge-container">
    <Breadcrumb items={breadcrumbs} />

    <!-- Page Heading -->
    <header class="page-header">
      <h1>VLOOKUP for Large Files</h1>
      <p class="page-subtitle">Merge and join large datasets with powerful operations</p>
    </header>

    <!-- Step 1: Upload Files -->
    <section id="step-upload" class="step" data-step="upload">
      <div class="step-header">
        <div class="step-badge">1</div>
        <div>
          <h2>Upload your files</h2>
          <p class="step-subtitle">CSV or Excel files to merge (multiple files per side supported)</p>
        </div>
      </div>

      <div class="upload-grid">
        <!-- Primary Files (Left) -->
        <div class="upload-box">
          <div class="upload-label">Primary Files (Left)</div>
          <div class="upload-area" id="upload-area-a" data-side="primary">
            <div class="upload-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
              </svg>
            </div>
            <p class="upload-text">Drop files or click to browse</p>
            <p class="upload-hint">Multiple files with matching columns will be combined</p>
            <input type="file" id="file-input-a" accept=".csv,.xlsx,.xls" multiple />
          </div>
          <div class="files-list" id="files-list-a"></div>
          <button class="btn-add-more" id="add-more-a" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Add more files
          </button>
          <div class="files-summary" id="files-summary-a" style="display: none;">
            <span class="summary-text" id="summary-text-a"></span>
            <button class="btn-clear" id="clear-a">Clear All</button>
          </div>
        </div>

        <!-- Secondary Files (Right) -->
        <div class="upload-box">
          <div class="upload-label">Secondary Files (Right)</div>
          <div class="upload-area" id="upload-area-b" data-side="secondary">
            <div class="upload-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
              </svg>
            </div>
            <p class="upload-text">Drop files or click to browse</p>
            <p class="upload-hint">Multiple files with matching columns will be combined</p>
            <input type="file" id="file-input-b" accept=".csv,.xlsx,.xls" multiple />
          </div>
          <div class="files-list" id="files-list-b"></div>
          <button class="btn-add-more" id="add-more-b" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Add more files
          </button>
          <div class="files-summary" id="files-summary-b" style="display: none;">
            <span class="summary-text" id="summary-text-b"></span>
            <button class="btn-clear" id="clear-b">Clear All</button>
          </div>
        </div>
      </div>

      <p class="help-text">
        Supports CSV and Excel files up to 500MB each. All files on the same side must have matching column headers.
      </p>

      <div class="upload-status" id="upload-status" style="display: none;">
        <div class="upload-progress">
          <div class="upload-progress-bar" id="upload-progress-bar"></div>
        </div>
        <span class="upload-status-text" id="upload-status-text">Uploading...</span>
      </div>
    </section>

    <!-- Step 2: Preview Data with Tabs -->
    <section id="step-preview" class="step" data-step="preview" style="display: none;">
      <div class="step-header">
        <div class="step-badge">2</div>
        <div>
          <h2>Preview your data</h2>
          <p class="step-subtitle">Confirm the data looks correct</p>
        </div>
      </div>

      <!-- Excel-style Tabs -->
      <div class="spreadsheet-container">
        <div class="sheet-tabs">
          <button class="sheet-tab active" data-tab="a" id="tab-a">
            <span class="tab-icon">A</span>
            <span class="tab-name" id="tab-name-a">File A</span>
            <span class="tab-meta" id="tab-meta-a"></span>
          </button>
          <button class="sheet-tab" data-tab="b" id="tab-b">
            <span class="tab-icon">B</span>
            <span class="tab-name" id="tab-name-b">File B</span>
            <span class="tab-meta" id="tab-meta-b"></span>
          </button>
        </div>

        <div class="sheet-content">
          <div class="sheet-panel active" id="panel-a">
            <div class="spreadsheet-wrapper">
              <table class="spreadsheet" id="preview-table-a">
                <thead id="preview-header-a"></thead>
                <tbody id="preview-body-a"></tbody>
              </table>
            </div>
          </div>
          <div class="sheet-panel" id="panel-b">
            <div class="spreadsheet-wrapper">
              <table class="spreadsheet" id="preview-table-b">
                <thead id="preview-header-b"></thead>
                <tbody id="preview-body-b"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-secondary" id="back-to-upload">Back</button>
        <button class="btn btn-primary" id="continue-to-config">Continue</button>
      </div>
    </section>

    <!-- Step 3: Configure Join -->
    <section id="step-config" class="step" data-step="config" style="display: none;">
      <div class="step-header">
        <div class="step-badge">3</div>
        <div>
          <h2>Configure the merge</h2>
          <p class="step-subtitle">Choose join type and matching columns</p>
        </div>
      </div>

      <div class="config-content">
        <!-- Join Type Selection -->
        <div class="form-section">
          <label class="form-label">Join Type</label>
          <div class="join-type-grid">
            <label class="join-option">
              <input type="radio" name="join-type" value="left" checked>
              <div class="join-card">
                <div class="join-icon">
                  <svg viewBox="0 0 48 24" fill="none">
                    <circle cx="16" cy="12" r="10" fill="var(--color-terracotta)" opacity="0.8"/>
                    <circle cx="32" cy="12" r="10" stroke="var(--color-border)" stroke-width="2" fill="none"/>
                  </svg>
                </div>
                <span class="join-name">Left Join</span>
                <span class="join-desc">All from File A + matches from B</span>
              </div>
            </label>

            <label class="join-option">
              <input type="radio" name="join-type" value="right">
              <div class="join-card">
                <div class="join-icon">
                  <svg viewBox="0 0 48 24" fill="none">
                    <circle cx="16" cy="12" r="10" stroke="var(--color-border)" stroke-width="2" fill="none"/>
                    <circle cx="32" cy="12" r="10" fill="var(--color-terracotta)" opacity="0.8"/>
                  </svg>
                </div>
                <span class="join-name">Right Join</span>
                <span class="join-desc">All from File B + matches from A</span>
              </div>
            </label>

            <label class="join-option">
              <input type="radio" name="join-type" value="inner">
              <div class="join-card">
                <div class="join-icon">
                  <svg viewBox="0 0 48 24" fill="none">
                    <circle cx="16" cy="12" r="10" stroke="var(--color-border)" stroke-width="2" fill="none"/>
                    <circle cx="32" cy="12" r="10" stroke="var(--color-border)" stroke-width="2" fill="none"/>
                    <ellipse cx="24" cy="12" rx="4" ry="8" fill="var(--color-terracotta)" opacity="0.8"/>
                  </svg>
                </div>
                <span class="join-name">Inner Join</span>
                <span class="join-desc">Only matching records</span>
              </div>
            </label>

            <label class="join-option">
              <input type="radio" name="join-type" value="outer">
              <div class="join-card">
                <div class="join-icon">
                  <svg viewBox="0 0 48 24" fill="none">
                    <circle cx="16" cy="12" r="10" fill="var(--color-terracotta)" opacity="0.8"/>
                    <circle cx="32" cy="12" r="10" fill="var(--color-terracotta)" opacity="0.8"/>
                  </svg>
                </div>
                <span class="join-name">Full Outer</span>
                <span class="join-desc">All records from both files</span>
              </div>
            </label>
          </div>
        </div>

        <!-- Key Column Selection -->
        <div class="form-section">
          <label class="form-label">Match Columns (Keys)</label>
          <p class="form-hint">Select the columns that should match between files</p>

          <div class="key-selection-grid">
            <div class="key-select-box">
              <label class="key-label">File A Column</label>
              <select id="key-column-a" class="form-select"></select>
              <div class="key-stats" id="key-stats-a"></div>
            </div>

            <div class="key-equals">=</div>

            <div class="key-select-box">
              <label class="key-label">File B Column</label>
              <select id="key-column-b" class="form-select"></select>
              <div class="key-stats" id="key-stats-b"></div>
            </div>
          </div>

          <!-- Match Preview -->
          <div class="match-preview" id="match-preview" style="display: none;">
            <div class="match-preview-content">
              <span class="match-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
              </span>
              <span class="match-text">
                <strong id="match-count">0</strong> matching keys found
                <span class="match-details" id="match-details"></span>
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-secondary" id="back-to-preview">Back</button>
        <button class="btn btn-primary" id="continue-to-columns">Continue</button>
      </div>
    </section>

    <!-- Step 4: Select Columns -->
    <section id="step-columns" class="step" data-step="columns" style="display: none;">
      <div class="step-header">
        <div class="step-badge">4</div>
        <div>
          <h2>Select output columns</h2>
          <p class="step-subtitle">Choose which columns to include in the result</p>
        </div>
      </div>

      <div class="columns-content">
        <div class="columns-list" id="columns-list">
          <!-- Columns will be populated dynamically -->
        </div>

        <div class="columns-actions">
          <button class="btn btn-secondary btn-small" id="select-all-columns">Select All</button>
          <button class="btn btn-secondary btn-small" id="deselect-all-columns">Deselect All</button>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-secondary" id="back-to-config">Back</button>
        <button class="btn btn-primary" id="start-merge">Merge Data</button>
      </div>
    </section>

    <!-- Step 5: Processing -->
    <section id="step-processing" class="step" data-step="processing" style="display: none;">
      <div class="step-header">
        <div class="step-badge">5</div>
        <div>
          <h2>Merging data</h2>
          <p class="step-subtitle" id="processing-status">Initializing...</p>
        </div>
      </div>

      <div class="step-content">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p class="progress-text" id="progress-text">0%</p>
      </div>
    </section>

    <!-- Step 6: Results -->
    <section id="step-results" class="step" data-step="results" style="display: none;">
      <div class="step-header">
        <div class="step-badge">6</div>
        <div>
          <h2>Merge complete</h2>
          <p class="step-subtitle">Your data has been merged successfully</p>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-grid">
        <div class="summary-card">
          <span class="summary-value" id="stat-left">0</span>
          <span class="summary-label">File A Rows</span>
        </div>
        <div class="summary-card">
          <span class="summary-value" id="stat-right">0</span>
          <span class="summary-label">File B Rows</span>
        </div>
        <div class="summary-card highlight">
          <span class="summary-value" id="stat-output">0</span>
          <span class="summary-label">Output Rows</span>
        </div>
        <div class="summary-card success">
          <span class="summary-value" id="stat-matched">0</span>
          <span class="summary-label">Matched</span>
        </div>
        <div class="summary-card warning">
          <span class="summary-value" id="stat-left-only">0</span>
          <span class="summary-label">Left Only</span>
        </div>
        <div class="summary-card warning">
          <span class="summary-value" id="stat-right-only">0</span>
          <span class="summary-label">Right Only</span>
        </div>
      </div>

      <!-- Results Preview -->
      <div class="results-section">
        <h3>Preview (first 100 rows)</h3>
        <div class="spreadsheet-wrapper results-spreadsheet">
          <table class="spreadsheet" id="results-table">
            <thead id="results-header"></thead>
            <tbody id="results-body"></tbody>
          </table>
        </div>
      </div>

      <div class="action-bar">
        <button class="btn btn-secondary" id="start-over">Start Over</button>
        <div class="download-buttons">
          <button class="btn btn-primary" id="download-csv">Download CSV</button>
          <button class="btn btn-secondary" id="download-excel">Download Excel</button>
        </div>
      </div>
    </section>

  </div>
</BaseLayout>

<style is:global>
  /* Auth Modal */
  .auth-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }

  .auth-modal.hidden {
    display: none;
  }

  .auth-modal-content {
    background: var(--color-paper);
    border-radius: 16px;
    padding: 32px;
    max-width: 420px;
    width: 100%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  }

  .auth-modal-content h2 {
    margin: 0 0 8px;
    font-size: 24px;
    color: var(--color-ink);
  }

  .auth-subtitle {
    margin: 0 0 24px;
    color: var(--color-ink-light);
    font-size: 14px;
  }

  .auth-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .auth-option {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    background: var(--color-cream);
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    font-family: inherit;
  }

  .auth-option:hover {
    border-color: var(--color-terracotta);
    background: white;
  }

  .auth-option-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .auth-option-icon.guest {
    background: #e0e7ff;
    color: #4f46e5;
  }

  .auth-option-icon.pro {
    background: #fef3c7;
    color: #d97706;
  }

  .auth-option-text {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .auth-option-title {
    font-weight: 600;
    font-size: 15px;
    color: var(--color-ink);
  }

  .auth-option-desc {
    font-size: 13px;
    color: var(--color-ink-light);
  }

  .auth-password-form {
    margin-top: 20px;
  }

  .auth-password-form input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--color-border);
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    margin-bottom: 12px;
  }

  .auth-password-form input:focus {
    outline: none;
    border-color: var(--color-terracotta);
  }

  .auth-password-actions {
    display: flex;
    gap: 8px;
  }

  .auth-password-actions .btn {
    flex: 1;
  }

  .auth-error {
    color: #dc2626;
    font-size: 13px;
    margin: 12px 0 0;
  }

  /* Access Mode Badge */
  .access-mode-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    margin-left: 12px;
    vertical-align: middle;
  }

  .access-mode-badge.guest {
    background: #e0e7ff;
    color: #4f46e5;
  }

  .access-mode-badge.pro {
    background: #fef3c7;
    color: #d97706;
  }

  /* Merge Container - Full width with max */
  .merge-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px 32px;
  }

  /* Upload Grid */
  .upload-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 16px;
  }

  .upload-box {
    position: relative;
  }

  .upload-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-ink);
    margin-bottom: 12px;
  }

  .upload-area {
    background: var(--color-paper);
    border: 2px dashed var(--color-border);
    border-radius: 12px;
    padding: 32px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .upload-area:hover,
  .upload-area.dragover {
    border-color: var(--color-terracotta);
    background: var(--color-cream);
  }

  .upload-area.has-file {
    display: none;
  }

  .upload-area input[type="file"] {
    display: none;
  }

  .upload-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 12px;
    background: var(--color-cream);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .upload-icon svg {
    width: 24px;
    height: 24px;
    stroke: var(--color-ink-light);
  }

  .upload-text {
    color: var(--color-ink-light);
    font-size: 14px;
    margin: 0;
  }

  .upload-hint {
    font-size: 12px;
    color: var(--color-ink-light);
    margin: 4px 0 0;
  }

  .files-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
  }

  .file-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--color-cream);
    border-radius: 8px;
  }

  .file-item.uploading {
    opacity: 0.7;
  }

  .file-item.error {
    background: #fef2f2;
    border: 1px solid #fca5a5;
  }

  .file-item .file-icon {
    width: 32px;
    height: 32px;
    background: var(--color-terracotta);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 600;
    flex-shrink: 0;
  }

  .file-item .file-details {
    flex: 1;
    min-width: 0;
  }

  .file-item .file-name {
    font-weight: 500;
    color: var(--color-ink);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .file-item .file-meta {
    font-size: 12px;
    color: var(--color-ink-light);
  }

  .file-item .file-progress {
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    margin-top: 6px;
    overflow: hidden;
  }

  .file-item .file-progress-bar {
    height: 100%;
    background: var(--color-terracotta);
    border-radius: 2px;
    transition: width 0.2s ease-out;
  }

  .file-item .btn-remove {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    color: var(--color-ink-light);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .file-item .btn-remove:hover {
    background: #fef2f2;
    color: #dc2626;
  }

  .files-summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 12px;
    padding: 12px 16px;
    background: #ecfdf5;
    border-radius: 8px;
    border: 1px solid #a7f3d0;
  }

  .files-summary .summary-text {
    font-size: 13px;
    color: #065f46;
    font-weight: 500;
  }

  .btn-clear {
    padding: 6px 12px;
    font-size: 12px;
    border: 1px solid #a7f3d0;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    color: #065f46;
  }

  .btn-clear:hover {
    background: #d1fae5;
  }

  .btn-add-more {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 12px 16px;
    margin-top: 8px;
    background: var(--color-paper);
    border: 2px dashed var(--color-border);
    border-radius: 8px;
    color: var(--color-ink-light);
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-add-more:hover {
    border-color: var(--color-terracotta);
    color: var(--color-terracotta);
    background: var(--color-cream);
  }

  .btn-add-more:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-add-more:disabled:hover {
    border-color: var(--color-border);
    color: var(--color-ink-light);
    background: var(--color-paper);
  }

  .upload-area.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .upload-box.disabled .upload-area,
  .upload-box.disabled .btn-add-more {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .upload-box.disabled .files-list {
    opacity: 0.7;
  }

  .upload-status {
    margin-top: 16px;
    padding: 12px 16px;
    background: #eff6ff;
    border-radius: 8px;
    border: 1px solid #bfdbfe;
  }

  .upload-progress {
    height: 4px;
    background: #dbeafe;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .upload-progress-bar {
    height: 100%;
    background: var(--color-terracotta);
    width: 0%;
    transition: width 0.3s;
  }

  .upload-status-text {
    font-size: 13px;
    color: #1e40af;
  }

  /* Excel-style Spreadsheet Tabs */
  .spreadsheet-container {
    border: 1px solid var(--color-border);
    border-radius: 8px;
    overflow: hidden;
    background: var(--color-paper);
    margin-bottom: 24px;
  }

  .sheet-tabs {
    display: flex;
    background: #f3f4f6;
    border-bottom: 1px solid var(--color-border);
    padding: 0 8px;
    gap: 2px;
  }

  .sheet-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 13px;
    font-family: inherit;
    color: var(--color-ink-light);
    transition: all 0.15s;
    margin-bottom: -1px;
  }

  .sheet-tab:hover {
    background: rgba(255, 255, 255, 0.5);
    color: var(--color-ink);
  }

  .sheet-tab.active {
    background: var(--color-paper);
    color: var(--color-ink);
    border-bottom-color: var(--color-terracotta);
    font-weight: 500;
  }

  .tab-icon {
    width: 20px;
    height: 20px;
    background: var(--color-terracotta);
    color: white;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
  }

  .sheet-tab[data-tab="b"] .tab-icon {
    background: #8b5cf6;
  }

  .tab-name {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .tab-meta {
    font-size: 11px;
    color: var(--color-ink-light);
    background: var(--color-cream);
    padding: 2px 6px;
    border-radius: 4px;
  }

  .sheet-content {
    position: relative;
  }

  .sheet-panel {
    display: none;
  }

  .sheet-panel.active {
    display: block;
  }

  /* Spreadsheet Table */
  .spreadsheet-wrapper {
    overflow: auto;
    max-height: 400px;
  }

  .results-spreadsheet {
    max-height: 500px;
  }

  .spreadsheet {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    table-layout: auto;
  }

  .spreadsheet th,
  .spreadsheet td {
    padding: 8px 12px;
    text-align: left;
    border-right: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
    white-space: nowrap;
    min-width: 100px;
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .spreadsheet th:last-child,
  .spreadsheet td:last-child {
    border-right: none;
  }

  .spreadsheet th {
    background: #f9fafb;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
    color: var(--color-ink);
  }

  .spreadsheet tbody tr:hover td {
    background: #f9fafb;
  }

  .spreadsheet .row-num {
    background: #f3f4f6;
    color: var(--color-ink-light);
    font-size: 11px;
    text-align: center;
    min-width: 50px;
    max-width: 50px;
    position: sticky;
    left: 0;
    z-index: 5;
  }

  .spreadsheet th.row-num {
    z-index: 15;
  }

  /* Join Type Grid */
  .join-type-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }

  .join-option input {
    display: none;
  }

  .join-card {
    padding: 16px;
    border: 2px solid var(--color-border);
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .join-option input:checked + .join-card {
    border-color: var(--color-terracotta);
    background: rgba(2, 132, 199, 0.05);
  }

  .join-icon {
    height: 32px;
    margin-bottom: 8px;
  }

  .join-icon svg {
    height: 24px;
    width: auto;
  }

  .join-name {
    display: block;
    font-weight: 600;
    font-size: 14px;
    color: var(--color-ink);
    margin-bottom: 4px;
  }

  .join-desc {
    font-size: 11px;
    color: var(--color-ink-light);
  }

  /* Key Selection */
  .key-selection-grid {
    display: flex;
    align-items: center;
    gap: 16px;
    max-width: 600px;
  }

  .key-select-box {
    flex: 1;
  }

  .key-label {
    display: block;
    font-size: 12px;
    color: var(--color-ink-light);
    margin-bottom: 6px;
  }

  .key-equals {
    font-size: 24px;
    color: var(--color-ink-light);
    padding-top: 20px;
  }

  .key-stats {
    margin-top: 8px;
    font-size: 12px;
    color: var(--color-ink-light);
  }

  .key-stats strong {
    color: var(--color-ink);
  }

  .match-preview {
    margin-top: 20px;
    padding: 16px;
    background: #ecfdf5;
    border-radius: 8px;
    border: 1px solid #a7f3d0;
  }

  .match-preview.warning {
    background: #fffbeb;
    border-color: #fcd34d;
  }

  .match-preview.error {
    background: #fef2f2;
    border-color: #fca5a5;
  }

  .match-preview-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .match-icon {
    color: #059669;
    flex-shrink: 0;
  }

  .match-preview.warning .match-icon {
    color: #d97706;
  }

  .match-preview.error .match-icon {
    color: #dc2626;
  }

  .match-text {
    font-size: 14px;
    color: var(--color-ink);
  }

  .match-text strong {
    font-weight: 600;
  }

  .match-details {
    display: block;
    font-size: 12px;
    color: var(--color-ink-light);
    margin-top: 2px;
  }

  /* File size warning */
  .file-size-warning {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: #fffbeb;
    border: 1px solid #fcd34d;
    border-radius: 8px;
    margin-top: 12px;
    font-size: 13px;
    color: #92400e;
  }

  .file-size-warning.error {
    background: #fef2f2;
    border-color: #fca5a5;
    color: #991b1b;
  }

  .backend-notice {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 8px;
    margin-top: 16px;
    font-size: 13px;
    color: #1e40af;
  }

  .backend-notice svg {
    flex-shrink: 0;
  }

  .form-hint {
    font-size: 13px;
    color: var(--color-ink-light);
    margin: 4px 0 16px;
  }

  /* Columns List */
  .columns-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 8px;
    margin-bottom: 16px;
    max-height: 400px;
    overflow-y: auto;
    padding: 4px;
  }

  .column-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--color-cream);
    border-radius: 6px;
    font-size: 13px;
  }

  .column-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    flex-shrink: 0;
  }

  .column-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .column-source {
    font-size: 11px;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .column-source.source-a {
    background: var(--color-terracotta);
  }

  .column-source.source-b {
    background: #8b5cf6;
  }

  .columns-actions {
    display: flex;
    gap: 8px;
  }

  .btn-small {
    padding: 8px 12px;
    font-size: 12px;
  }

  /* Summary Grid */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .summary-card {
    background: var(--color-cream);
    padding: 16px;
    border-radius: 8px;
    text-align: center;
  }

  .summary-card.highlight {
    background: rgba(2, 132, 199, 0.1);
  }

  .summary-card.success {
    background: #ecfdf5;
  }

  .summary-card.warning {
    background: #fffbeb;
  }

  .summary-value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: var(--color-ink);
    margin-bottom: 4px;
  }

  .summary-card.highlight .summary-value {
    color: var(--color-terracotta);
  }

  .summary-card.success .summary-value {
    color: #059669;
  }

  .summary-card.warning .summary-value {
    color: #d97706;
  }

  .summary-label {
    font-size: 12px;
    color: var(--color-ink-light);
  }

  /* Results */
  .results-section {
    margin-bottom: 24px;
  }

  .results-section h3 {
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 12px;
  }

  .download-buttons {
    display: flex;
    gap: 8px;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .merge-container {
      padding: 24px 20px;
    }
  }

  @media (max-width: 900px) {
    .upload-grid {
      grid-template-columns: 1fr;
    }

    .join-type-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .summary-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 640px) {
    .merge-container {
      padding: 16px;
    }

    .summary-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .key-selection-grid {
      flex-direction: column;
    }

    .key-equals {
      padding: 0;
      transform: rotate(90deg);
    }

    .sheet-tabs {
      overflow-x: auto;
    }
  }
</style>

<!-- SheetJS for Excel parsing and export -->
<script is:inline src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<script is:inline>
  // Auth state
  let accessMode = null; // 'guest' or 'pro'
  const ACCESS_PASSWORD = 'Florida'; // Simple password check

  // Limits based on access mode
  const GUEST_FILE_SIZE_LIMIT = 10 * 1024 * 1024; // 10MB
  const PRO_FILE_SIZE_LIMIT = 500 * 1024 * 1024; // 500MB
  const GUEST_MAX_FILES_PER_SIDE = 1;

  // State - now supports multiple files per side
  let primaryFiles = []; // Array of { file, r2Key, filename, size, status, columns, rowCount }
  let secondaryFiles = [];
  let primaryData = { columns: [], preview: [], rowCount: 0, uniqueCounts: {} };
  let secondaryData = { columns: [], preview: [], rowCount: 0, uniqueCounts: {} };
  let mergeResult = null;
  let currentStep = 'upload';
  let resultKey = null; // R2 key for result file
  let isUploading = false; // Track if any upload is in progress

  // Get current file size limit based on access mode
  function getFileSizeLimit() {
    return accessMode === 'pro' ? PRO_FILE_SIZE_LIMIT : GUEST_FILE_SIZE_LIMIT;
  }

  // Check if can add more files (guest = 1 per side)
  function canAddMoreFiles(side) {
    if (accessMode === 'pro') return true;
    const filesList = side === 'primary' ? primaryFiles : secondaryFiles;
    return filesList.length < GUEST_MAX_FILES_PER_SIDE;
  }

  // API URLs
  const R2_UPLOAD_URL = '/api/merge/upload'; // CF Pages API -> R2
  const BACKEND_URL = window.location.hostname === 'localhost'
    ? 'http://localhost:8000/api/merge'
    : 'https://api.kirubashankar.com/api/merge';

  // Step mapping
  const steps = ['upload', 'preview', 'config', 'columns', 'processing', 'results'];

  // DOM Elements
  const elements = {
    stepUpload: document.getElementById('step-upload'),
    stepPreview: document.getElementById('step-preview'),
    stepConfig: document.getElementById('step-config'),
    stepColumns: document.getElementById('step-columns'),
    stepProcessing: document.getElementById('step-processing'),
    stepResults: document.getElementById('step-results'),
    // Upload areas
    uploadAreaA: document.getElementById('upload-area-a'),
    uploadAreaB: document.getElementById('upload-area-b'),
    fileInputA: document.getElementById('file-input-a'),
    fileInputB: document.getElementById('file-input-b'),
    filesListA: document.getElementById('files-list-a'),
    filesListB: document.getElementById('files-list-b'),
    filesSummaryA: document.getElementById('files-summary-a'),
    filesSummaryB: document.getElementById('files-summary-b'),
    summaryTextA: document.getElementById('summary-text-a'),
    summaryTextB: document.getElementById('summary-text-b'),
    clearA: document.getElementById('clear-a'),
    clearB: document.getElementById('clear-b'),
    addMoreA: document.getElementById('add-more-a'),
    addMoreB: document.getElementById('add-more-b'),
    uploadBoxA: document.getElementById('upload-area-a').parentElement,
    uploadBoxB: document.getElementById('upload-area-b').parentElement,
    uploadStatus: document.getElementById('upload-status'),
    uploadProgressBar: document.getElementById('upload-progress-bar'),
    uploadStatusText: document.getElementById('upload-status-text'),
    // Preview tabs
    tabA: document.getElementById('tab-a'),
    tabB: document.getElementById('tab-b'),
    tabNameA: document.getElementById('tab-name-a'),
    tabNameB: document.getElementById('tab-name-b'),
    tabMetaA: document.getElementById('tab-meta-a'),
    tabMetaB: document.getElementById('tab-meta-b'),
    panelA: document.getElementById('panel-a'),
    panelB: document.getElementById('panel-b'),
    previewHeaderA: document.getElementById('preview-header-a'),
    previewHeaderB: document.getElementById('preview-header-b'),
    previewBodyA: document.getElementById('preview-body-a'),
    previewBodyB: document.getElementById('preview-body-b'),
    // Config
    keyColumnA: document.getElementById('key-column-a'),
    keyColumnB: document.getElementById('key-column-b'),
    keyStatsA: document.getElementById('key-stats-a'),
    keyStatsB: document.getElementById('key-stats-b'),
    matchPreview: document.getElementById('match-preview'),
    matchCount: document.getElementById('match-count'),
    matchDetails: document.getElementById('match-details'),
    columnsList: document.getElementById('columns-list'),
    // Processing
    processingStatus: document.getElementById('processing-status'),
    progressFill: document.getElementById('progress-fill'),
    progressText: document.getElementById('progress-text'),
    // Results
    resultsHeader: document.getElementById('results-header'),
    resultsBody: document.getElementById('results-body'),
  };

  // URL-based navigation
  function updateURL(step) {
    const newURL = `${window.location.pathname}#${step}`;
    history.pushState({ step }, '', newURL);
  }

  function getStepFromURL() {
    const hash = window.location.hash.replace('#', '');
    return steps.includes(hash) ? hash : 'upload';
  }

  // Handle browser back/forward
  window.addEventListener('popstate', (e) => {
    const step = e.state?.step || getStepFromURL();
    showStep(step, false);
  });

  // Format file size
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // Escape HTML
  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
  }

  // Update progress
  function updateProgress(percent, message) {
    elements.progressFill.style.width = percent + '%';
    elements.progressText.textContent = percent + '%';
    if (message) {
      elements.processingStatus.textContent = message;
    }
  }

  // Show step
  function showStep(step, updateHistory = true) {
    currentStep = step;

    elements.stepUpload.style.display = 'none';
    elements.stepPreview.style.display = 'none';
    elements.stepConfig.style.display = 'none';
    elements.stepColumns.style.display = 'none';
    elements.stepProcessing.style.display = 'none';
    elements.stepResults.style.display = 'none';

    const stepEl = document.getElementById('step-' + step);
    if (stepEl) {
      stepEl.style.display = 'block';
    }

    if (updateHistory) {
      updateURL(step);
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Tab switching
  function switchTab(tab) {
    elements.tabA.classList.toggle('active', tab === 'a');
    elements.tabB.classList.toggle('active', tab === 'b');
    elements.panelA.classList.toggle('active', tab === 'a');
    elements.panelB.classList.toggle('active', tab === 'b');
  }

  elements.tabA.addEventListener('click', () => switchTab('a'));
  elements.tabB.addEventListener('click', () => switchTab('b'));

  // =====================
  // File Upload to R2 (Direct with Presigned URL)
  // =====================

  // Update upload box disabled states
  function updateUploadDisabledStates(uploadingSide) {
    if (uploadingSide) {
      isUploading = true;
      // Disable the OTHER side while uploading
      if (uploadingSide === 'primary') {
        elements.uploadBoxB.classList.add('disabled');
        elements.addMoreB.disabled = true;
      } else {
        elements.uploadBoxA.classList.add('disabled');
        elements.addMoreA.disabled = true;
      }
    } else {
      isUploading = false;
      elements.uploadBoxA.classList.remove('disabled');
      elements.uploadBoxB.classList.remove('disabled');
      elements.addMoreA.disabled = false;
      elements.addMoreB.disabled = false;
    }
  }

  // Parse file locally to extract column names (for validation)
  async function extractColumnsFromFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');

      reader.onload = (e) => {
        try {
          if (isExcel) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', sheetRows: 1 });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            if (json.length > 0) {
              resolve(json[0].map(c => String(c)));
            } else {
              resolve([]);
            }
          } else {
            // CSV - just read the first line
            const text = e.target.result;
            const firstLine = text.split('\n')[0].trim();
            // Simple CSV header parsing (handles basic cases)
            const cols = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < firstLine.length; i++) {
              const char = firstLine[i];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === ',' && !inQuotes) {
                cols.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            cols.push(current.trim());
            resolve(cols);
          }
        } catch (err) {
          reject(err);
        }
      };

      reader.onerror = () => reject(new Error('Failed to read file'));

      if (isExcel) {
        reader.readAsArrayBuffer(file);
      } else {
        // For CSV, just read the first 10KB to get headers
        reader.readAsText(file.slice(0, 10240));
      }
    });
  }

  // Get presigned upload URL from backend
  async function getUploadUrl(filename) {
    const params = new URLSearchParams({ filename });
    const response = await fetch(`${BACKEND_URL}/r2/upload-url?${params}`, {
      method: 'POST'
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ detail: 'Failed to get upload URL' }));
      throw new Error(error.detail || 'Failed to get upload URL');
    }

    return await response.json();
  }

  // Upload file directly to R2 using presigned URL
  async function uploadToR2Direct(file, uploadUrl, onProgress) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();

      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable && onProgress) {
          const percent = Math.round((e.loaded / e.total) * 100);
          onProgress(percent, e.loaded, e.total);
        }
      });

      xhr.addEventListener('load', () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          resolve();
        } else {
          console.error('R2 upload error:', xhr.status, xhr.responseText);
          reject(new Error(`Upload failed: ${xhr.status}`));
        }
      });

      xhr.addEventListener('error', () => reject(new Error('Network error during upload')));
      xhr.addEventListener('abort', () => reject(new Error('Upload cancelled')));

      xhr.open('PUT', uploadUrl);
      // Send file directly - don't set Content-Type to avoid signature mismatch
      xhr.send(file);
    });
  }

  // Upload a single file to R2 (get URL, then upload directly)
  async function uploadFileToR2(file, onProgress) {
    // Step 1: Get presigned upload URL from backend
    onProgress && onProgress(0, 0, file.size);
    const { uploadUrl, key } = await getUploadUrl(file.name);

    // Step 2: Upload directly to R2
    await uploadToR2Direct(file, uploadUrl, onProgress);

    return { key, filename: file.name, size: file.size };
  }

  // Handle multiple file uploads for a side
  async function handleFilesUpload(files, side) {
    const filesList = side === 'primary' ? primaryFiles : secondaryFiles;
    const filesListEl = side === 'primary' ? elements.filesListA : elements.filesListB;
    const uploadArea = side === 'primary' ? elements.uploadAreaA : elements.uploadAreaB;
    const addMoreBtn = side === 'primary' ? elements.addMoreA : elements.addMoreB;

    // Get reference columns from existing uploaded files on this side
    const existingUploaded = filesList.filter(f => f.status === 'uploaded' && f.columns);
    const referenceColumns = existingUploaded.length > 0 ? existingUploaded[0].columns : null;

    // Disable the other side while uploading
    updateUploadDisabledStates(side);

    const fileSizeLimit = getFileSizeLimit();
    const fileSizeLimitText = accessMode === 'pro' ? '500MB' : '10MB';

    for (const file of files) {
      // Check if can add more files (guest mode limit)
      if (!canAddMoreFiles(side)) {
        alert(`Guest mode allows only 1 file per side. Enter password for multiple files.`);
        break;
      }

      // Validate file size
      if (file.size > fileSizeLimit) {
        alert(`File "${file.name}" is too large (${formatFileSize(file.size)}). Maximum is ${fileSizeLimitText} per file${accessMode === 'guest' ? ' in guest mode' : ''}.`);
        continue;
      }

      // Validate file type
      const ext = file.name.split('.').pop().toLowerCase();
      if (!['csv', 'xlsx', 'xls'].includes(ext)) {
        alert(`File "${file.name}" is not a supported format. Please use CSV or Excel files.`);
        continue;
      }

      // Extract columns from file for validation
      let fileColumns;
      try {
        fileColumns = await extractColumnsFromFile(file);
      } catch (err) {
        alert(`Could not read headers from "${file.name}": ${err.message}`);
        continue;
      }

      // Validate columns match existing files on this side
      if (referenceColumns) {
        if (fileColumns.length !== referenceColumns.length) {
          alert(`File "${file.name}" has ${fileColumns.length} columns, but existing files have ${referenceColumns.length} columns. All files on the same side must have matching column headers.`);
          continue;
        }

        const mismatched = fileColumns.filter((c, i) => c !== referenceColumns[i]);
        if (mismatched.length > 0) {
          alert(`File "${file.name}" has different column headers than existing files.\n\nMismatched: ${mismatched.slice(0, 3).join(', ')}${mismatched.length > 3 ? '...' : ''}\n\nAll files on the same side must have matching column headers.`);
          continue;
        }
      }

      // Add file to list with "uploading" status
      const fileEntry = {
        file,
        filename: file.name,
        size: file.size,
        status: 'uploading',
        progress: 0,
        r2Key: null,
        columns: fileColumns,
        error: null
      };
      filesList.push(fileEntry);
      renderFilesList(side);

      // Hide upload area, show add more button
      uploadArea.classList.add('has-file');
      addMoreBtn.style.display = 'flex';

      try {
        // Upload to R2 with progress tracking
        const result = await uploadFileToR2(file, (percent, loaded, total) => {
          fileEntry.progress = percent;
          // Update just this file's progress display
          const fileItem = filesListEl.querySelector(`[data-index="${filesList.indexOf(fileEntry)}"] .file-meta`);
          if (fileItem) {
            fileItem.textContent = `Uploading... ${percent}% (${formatFileSize(loaded)} / ${formatFileSize(total)})`;
          }
        });
        fileEntry.r2Key = result.key;
        fileEntry.status = 'uploaded';
        fileEntry.progress = 100;
        renderFilesList(side);
      } catch (error) {
        console.error('Upload error:', error);
        fileEntry.status = 'error';
        fileEntry.error = error.message;
        renderFilesList(side);
      }
    }

    // Re-enable both sides after upload completes
    updateUploadDisabledStates(null);

    // Check if we can proceed to preview
    checkFilesReady();
  }

  // Render file list for a side
  function renderFilesList(side) {
    const filesList = side === 'primary' ? primaryFiles : secondaryFiles;
    const filesListEl = side === 'primary' ? elements.filesListA : elements.filesListB;
    const summaryEl = side === 'primary' ? elements.filesSummaryA : elements.filesSummaryB;
    const summaryTextEl = side === 'primary' ? elements.summaryTextA : elements.summaryTextB;
    const uploadArea = side === 'primary' ? elements.uploadAreaA : elements.uploadAreaB;
    const addMoreBtn = side === 'primary' ? elements.addMoreA : elements.addMoreB;

    if (filesList.length === 0) {
      filesListEl.innerHTML = '';
      summaryEl.style.display = 'none';
      addMoreBtn.style.display = 'none';
      uploadArea.classList.remove('has-file');
      return;
    }

    // Show add more button if we have files (only in pro mode or if under limit)
    uploadArea.classList.add('has-file');
    if (accessMode === 'pro' || filesList.length < GUEST_MAX_FILES_PER_SIDE) {
      addMoreBtn.style.display = 'flex';
    } else {
      addMoreBtn.style.display = 'none';
    }

    // Render each file
    filesListEl.innerHTML = filesList.map((f, idx) => {
      const ext = f.filename.split('.').pop().toUpperCase();
      const statusClass = f.status === 'uploading' ? 'uploading' : (f.status === 'error' ? 'error' : '');
      const statusText = f.status === 'uploading' ? `Uploading... ${f.progress || 0}%` :
                        (f.status === 'error' ? f.error : formatFileSize(f.size));
      const progressBar = f.status === 'uploading'
        ? `<div class="file-progress"><div class="file-progress-bar" style="width: ${f.progress || 0}%"></div></div>`
        : '';

      return `
        <div class="file-item ${statusClass}" data-index="${idx}">
          <div class="file-icon">${ext}</div>
          <div class="file-details">
            <div class="file-name">${escapeHtml(f.filename)}</div>
            <div class="file-meta">${statusText}</div>
            ${progressBar}
          </div>
          <button class="btn-remove" data-side="${side}" data-index="${idx}">&times;</button>
        </div>
      `;
    }).join('');

    // Add remove button listeners
    filesListEl.querySelectorAll('.btn-remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const idx = parseInt(btn.dataset.index);
        const s = btn.dataset.side;
        removeFile(s, idx);
      });
    });

    // Update summary
    const uploadedFiles = filesList.filter(f => f.status === 'uploaded');
    const totalSize = uploadedFiles.reduce((sum, f) => sum + f.size, 0);

    if (uploadedFiles.length > 0) {
      summaryEl.style.display = 'flex';
      summaryTextEl.textContent = `${uploadedFiles.length} file${uploadedFiles.length > 1 ? 's' : ''} ready (${formatFileSize(totalSize)})`;
    } else {
      summaryEl.style.display = 'none';
    }
  }

  // Remove a file from a side
  function removeFile(side, index) {
    const filesList = side === 'primary' ? primaryFiles : secondaryFiles;
    filesList.splice(index, 1);
    renderFilesList(side);

    // Reset data if all files removed
    if (side === 'primary' && primaryFiles.length === 0) {
      primaryData = { columns: [], preview: [], rowCount: 0, uniqueCounts: {} };
    } else if (side === 'secondary' && secondaryFiles.length === 0) {
      secondaryData = { columns: [], preview: [], rowCount: 0, uniqueCounts: {} };
    }
  }

  // Clear all files from a side
  function clearFiles(side) {
    if (side === 'primary') {
      primaryFiles = [];
      primaryData = { columns: [], preview: [], rowCount: 0, uniqueCounts: {} };
      elements.fileInputA.value = '';
    } else {
      secondaryFiles = [];
      secondaryData = { columns: [], preview: [], rowCount: 0, uniqueCounts: {} };
      elements.fileInputB.value = '';
    }
    renderFilesList(side);
  }

  // Check if both sides have uploaded files and fetch previews
  async function checkFilesReady() {
    const primaryReady = primaryFiles.filter(f => f.status === 'uploaded');
    const secondaryReady = secondaryFiles.filter(f => f.status === 'uploaded');

    if (primaryReady.length === 0 || secondaryReady.length === 0) {
      return;
    }

    // Show loading status
    elements.uploadStatus.style.display = 'block';
    elements.uploadStatusText.textContent = 'Validating files...';
    elements.uploadProgressBar.style.width = '50%';

    try {
      // Fetch previews from DO API
      const [primaryPreview, secondaryPreview] = await Promise.all([
        fetchPreview(primaryReady.map(f => f.r2Key)),
        fetchPreview(secondaryReady.map(f => f.r2Key))
      ]);

      primaryData = {
        columns: primaryPreview.columns,
        preview: primaryPreview.preview,
        rowCount: primaryPreview.rowCount,
        uniqueCounts: primaryPreview.uniqueCounts,
        fileCount: primaryPreview.fileCount
      };

      secondaryData = {
        columns: secondaryPreview.columns,
        preview: secondaryPreview.preview,
        rowCount: secondaryPreview.rowCount,
        uniqueCounts: secondaryPreview.uniqueCounts,
        fileCount: secondaryPreview.fileCount
      };

      elements.uploadStatus.style.display = 'none';

      // Auto-proceed to preview
      showPreview();

    } catch (error) {
      console.error('Preview error:', error);
      elements.uploadStatus.style.display = 'none';
      alert('Error validating files: ' + error.message);
    }
  }

  // Fetch preview from DO API
  async function fetchPreview(keys) {
    const response = await fetch(`${BACKEND_URL}/r2/preview`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ keys })
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ detail: 'Preview failed' }));
      throw new Error(error.detail || 'Preview failed');
    }

    return await response.json();
  }

  // =====================
  // Preview Step
  // =====================

  function showPreview() {
    // Update tab names
    const primaryNames = primaryFiles.filter(f => f.status === 'uploaded').map(f => f.filename);
    const secondaryNames = secondaryFiles.filter(f => f.status === 'uploaded').map(f => f.filename);

    elements.tabNameA.textContent = primaryNames.length > 1
      ? `${primaryNames.length} files combined`
      : primaryNames[0] || 'Primary';
    elements.tabNameB.textContent = secondaryNames.length > 1
      ? `${secondaryNames.length} files combined`
      : secondaryNames[0] || 'Secondary';

    elements.tabMetaA.textContent = `${primaryData.rowCount.toLocaleString()} rows`;
    elements.tabMetaB.textContent = `${secondaryData.rowCount.toLocaleString()} rows`;

    // Render preview tables
    renderSpreadsheet(primaryData, elements.previewHeaderA, elements.previewBodyA);
    renderSpreadsheet(secondaryData, elements.previewHeaderB, elements.previewBodyB);

    switchTab('a');
    showStep('preview');
  }

  function renderSpreadsheet(data, headerEl, bodyEl) {
    headerEl.innerHTML = '<tr><th class="row-num">#</th>' +
      data.columns.map(c => `<th>${escapeHtml(c)}</th>`).join('') +
      '</tr>';

    bodyEl.innerHTML = data.preview.map((row, idx) =>
      `<tr><td class="row-num">${idx + 1}</td>` +
      data.columns.map(col => `<td>${escapeHtml(row[col])}</td>`).join('') +
      '</tr>'
    ).join('');
  }

  // =====================
  // Config Step
  // =====================

  function showConfig() {
    // Populate key column dropdowns
    elements.keyColumnA.innerHTML = primaryData.columns.map(c =>
      `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`
    ).join('');

    elements.keyColumnB.innerHTML = secondaryData.columns.map(c =>
      `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`
    ).join('');

    elements.keyColumnA.onchange = updateMatchPreview;
    elements.keyColumnB.onchange = updateMatchPreview;

    updateMatchPreview();
    showStep('config');
  }

  async function updateMatchPreview() {
    const keyA = elements.keyColumnA.value;
    const keyB = elements.keyColumnB.value;

    if (!keyA || !keyB) {
      elements.matchPreview.style.display = 'none';
      return;
    }

    // Use unique counts from preview data
    const uniqueA = primaryData.uniqueCounts[keyA] || 0;
    const uniqueB = secondaryData.uniqueCounts[keyB] || 0;

    elements.keyStatsA.innerHTML = `<strong>${uniqueA.toLocaleString()}</strong> unique values`;
    elements.keyStatsB.innerHTML = `<strong>${uniqueB.toLocaleString()}</strong> unique values`;

    // Simple estimate based on unique counts (actual match requires server processing)
    elements.matchPreview.style.display = 'block';
    elements.matchPreview.classList.remove('warning', 'error');
    elements.matchCount.textContent = '~';
    elements.matchDetails.textContent = 'Exact match count will be calculated during merge';
  }

  // =====================
  // Columns Step
  // =====================

  function showColumns() {
    const allColumns = [];

    primaryData.columns.forEach(col => {
      allColumns.push({ name: col, source: 'A', checked: true });
    });

    secondaryData.columns.forEach(col => {
      if (col !== elements.keyColumnB.value) {
        allColumns.push({ name: col, source: 'B', checked: true });
      }
    });

    elements.columnsList.innerHTML = allColumns.map((col) => `
      <label class="column-item">
        <input type="checkbox" name="column" value="${escapeHtml(col.name)}" data-source="${col.source}" ${col.checked ? 'checked' : ''}>
        <span class="column-name">${escapeHtml(col.name)}</span>
        <span class="column-source source-${col.source.toLowerCase()}">File ${col.source}</span>
      </label>
    `).join('');

    showStep('columns');
  }

  // =====================
  // Merge Execution
  // =====================

  async function startMerge() {
    showStep('processing');
    updateProgress(0, 'Starting merge...');

    const joinType = document.querySelector('input[name="join-type"]:checked').value;
    const leftKey = elements.keyColumnA.value;
    const rightKey = elements.keyColumnB.value;

    const selectedColumns = [];
    document.querySelectorAll('input[name="column"]:checked').forEach(cb => {
      selectedColumns.push(cb.value);
    });

    try {
      updateProgress(5, 'Sending merge request...');

      // Get R2 keys for uploaded files
      const primaryKeys = primaryFiles.filter(f => f.status === 'uploaded').map(f => f.r2Key);
      const secondaryKeys = secondaryFiles.filter(f => f.status === 'uploaded').map(f => f.r2Key);

      const response = await fetch(`${BACKEND_URL}/r2/jobs`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          primaryKeys,
          secondaryKeys,
          joinType,
          leftKey,
          rightKey,
          selectedColumns: selectedColumns.length > 0 ? selectedColumns : null
        })
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ detail: 'Merge request failed' }));
        throw new Error(error.detail || 'Merge request failed');
      }

      const result = await response.json();
      pollMergeJob(result.jobId);

    } catch (error) {
      console.error('Merge error:', error);
      alert('Error starting merge: ' + error.message);
      showStep('columns');
    }
  }

  async function pollMergeJob(jobId) {
    try {
      const response = await fetch(`${BACKEND_URL}/jobs/${jobId}`);
      if (!response.ok) {
        throw new Error('Failed to get job status');
      }

      const job = await response.json();

      if (job.status === 'processing') {
        updateProgress(job.progress || 10, job.message || 'Processing...');
        setTimeout(() => pollMergeJob(jobId), 500);
      } else if (job.status === 'complete') {
        resultKey = job.resultId; // This is an R2 key like "results/uuid.csv"
        handleMergeComplete(job);
      } else if (job.status === 'error') {
        throw new Error(job.message || 'Merge failed');
      }
    } catch (error) {
      console.error('Poll error:', error);
      alert('Error during merge: ' + error.message);
      showStep('columns');
    }
  }

  function handleMergeComplete(job) {
    mergeResult = {
      stats: job.stats,
      columns: job.columns,
      preview: job.preview
    };

    // Update summary stats
    document.getElementById('stat-left').textContent = job.stats.leftRows.toLocaleString();
    document.getElementById('stat-right').textContent = job.stats.rightRows.toLocaleString();
    document.getElementById('stat-output').textContent = job.stats.outputRows.toLocaleString();
    document.getElementById('stat-matched').textContent = job.stats.matched.toLocaleString();
    document.getElementById('stat-left-only').textContent = job.stats.leftOnly.toLocaleString();
    document.getElementById('stat-right-only').textContent = job.stats.rightOnly.toLocaleString();

    // Render results table
    elements.resultsHeader.innerHTML = '<tr><th class="row-num">#</th>' +
      job.columns.map(c => `<th>${escapeHtml(c)}</th>`).join('') +
      '</tr>';

    elements.resultsBody.innerHTML = job.preview.map((row, idx) =>
      `<tr><td class="row-num">${idx + 1}</td>` +
      job.columns.map(col => `<td>${escapeHtml(row[col])}</td>`).join('') +
      '</tr>'
    ).join('');

    if (job.stats.outputRows > 100) {
      elements.resultsBody.innerHTML += `<tr><td colspan="${job.columns.length + 1}" style="text-align: center; color: var(--color-ink-light); background: #f9fafb;">... and ${(job.stats.outputRows - 100).toLocaleString()} more rows</td></tr>`;
    }

    showStep('results');
  }

  // =====================
  // Download Functions
  // =====================

  async function downloadCSV() {
    if (!resultKey) return;

    try {
      // Get presigned URL from backend
      const response = await fetch(`${BACKEND_URL}/r2/results/${encodeURIComponent(resultKey)}`);
      if (!response.ok) {
        throw new Error('Failed to get download URL');
      }

      const data = await response.json();
      window.location.href = data.downloadUrl;
    } catch (error) {
      console.error('Download error:', error);
      alert('Error downloading file: ' + error.message);
    }
  }

  async function downloadExcel() {
    if (!mergeResult || !resultKey) return;

    try {
      // For Excel, we need to fetch the CSV and convert client-side
      const response = await fetch(`${BACKEND_URL}/r2/results/${encodeURIComponent(resultKey)}`);
      if (!response.ok) {
        throw new Error('Failed to get download URL');
      }

      const data = await response.json();

      // Fetch the CSV data
      const csvResponse = await fetch(data.downloadUrl);
      const csvText = await csvResponse.text();

      // Parse CSV to array
      const rows = csvText.split('\n').map(line => {
        const cells = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"' && line[i + 1] === '"') {
            current += '"';
            i++;
          } else if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            cells.push(current);
            current = '';
          } else {
            current += char;
          }
        }
        cells.push(current);
        return cells;
      });

      // Create Excel workbook
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Merged Data');

      // Add summary sheet
      const summaryData = [
        ['Merge Summary'],
        [''],
        ['Primary Files Rows', mergeResult.stats.leftRows],
        ['Secondary Files Rows', mergeResult.stats.rightRows],
        ['Output Rows', mergeResult.stats.outputRows],
        ['Matched', mergeResult.stats.matched],
        ['Left Only', mergeResult.stats.leftOnly],
        ['Right Only', mergeResult.stats.rightOnly],
        [''],
        ['Join Type', mergeResult.stats.joinType],
      ];
      const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');

      XLSX.writeFile(wb, 'merged_data.xlsx');

    } catch (error) {
      console.error('Excel download error:', error);
      alert('Error creating Excel file: ' + error.message);
    }
  }

  // =====================
  // Reset
  // =====================

  function reset() {
    primaryFiles = [];
    secondaryFiles = [];
    primaryData = { columns: [], preview: [], rowCount: 0, uniqueCounts: {} };
    secondaryData = { columns: [], preview: [], rowCount: 0, uniqueCounts: {} };
    mergeResult = null;
    resultKey = null;

    elements.fileInputA.value = '';
    elements.fileInputB.value = '';
    elements.progressFill.style.width = '0%';
    elements.progressText.textContent = '0%';

    renderFilesList('primary');
    renderFilesList('secondary');

    showStep('upload');
  }

  // =====================
  // Event Setup
  // =====================

  function setupUploadArea(uploadArea, fileInput, side) {
    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFilesUpload(Array.from(e.dataTransfer.files), side);
    });

    fileInput.addEventListener('change', (e) => {
      handleFilesUpload(Array.from(e.target.files), side);
      e.target.value = ''; // Reset so same files can be selected again
    });
  }

  // Initialize upload areas
  setupUploadArea(elements.uploadAreaA, elements.fileInputA, 'primary');
  setupUploadArea(elements.uploadAreaB, elements.fileInputB, 'secondary');

  // Clear buttons
  elements.clearA.addEventListener('click', () => clearFiles('primary'));
  elements.clearB.addEventListener('click', () => clearFiles('secondary'));

  // Add more buttons
  elements.addMoreA.addEventListener('click', () => {
    if (!isUploading) elements.fileInputA.click();
  });
  elements.addMoreB.addEventListener('click', () => {
    if (!isUploading) elements.fileInputB.click();
  });

  // Navigation buttons
  document.getElementById('back-to-upload').addEventListener('click', () => showStep('upload'));
  document.getElementById('continue-to-config').addEventListener('click', showConfig);
  document.getElementById('back-to-preview').addEventListener('click', showPreview);
  document.getElementById('continue-to-columns').addEventListener('click', showColumns);
  document.getElementById('back-to-config').addEventListener('click', showConfig);
  document.getElementById('start-merge').addEventListener('click', startMerge);
  document.getElementById('start-over').addEventListener('click', reset);
  document.getElementById('download-csv').addEventListener('click', downloadCSV);
  document.getElementById('download-excel').addEventListener('click', downloadExcel);

  // Column selection
  document.getElementById('select-all-columns').addEventListener('click', () => {
    document.querySelectorAll('input[name="column"]').forEach(cb => cb.checked = true);
  });

  document.getElementById('deselect-all-columns').addEventListener('click', () => {
    document.querySelectorAll('input[name="column"]').forEach(cb => cb.checked = false);
  });

  // =====================
  // Auth Modal Handling
  // =====================

  const authModal = document.getElementById('auth-modal');
  const authGuestBtn = document.getElementById('auth-guest');
  const authPasswordBtn = document.getElementById('auth-password');
  const authPasswordForm = document.getElementById('auth-password-form');
  const authOptions = document.querySelector('.auth-options');
  const authPasswordInput = document.getElementById('auth-password-input');
  const authBackBtn = document.getElementById('auth-back');
  const authSubmitBtn = document.getElementById('auth-submit');
  const authError = document.getElementById('auth-error');

  function setAccessMode(mode) {
    accessMode = mode;
    authModal.classList.add('hidden');

    // Update UI to show access mode
    const badge = document.createElement('span');
    badge.className = `access-mode-badge ${mode}`;
    badge.innerHTML = mode === 'pro'
      ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Full Access'
      : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Guest';

    const pageTitle = document.querySelector('.page-header h1');
    if (pageTitle && !pageTitle.querySelector('.access-mode-badge')) {
      pageTitle.appendChild(badge);
    }

    // Update help text based on mode
    const helpText = document.querySelector('.help-text');
    if (helpText) {
      if (mode === 'guest') {
        helpText.textContent = 'Guest mode: 1 file per side, max 10MB each. Enter password for full access.';
      } else {
        helpText.textContent = 'Supports CSV and Excel files up to 500MB each. All files on the same side must have matching column headers.';
      }
    }
  }

  authGuestBtn.addEventListener('click', () => {
    setAccessMode('guest');
  });

  authPasswordBtn.addEventListener('click', () => {
    authOptions.style.display = 'none';
    authPasswordForm.style.display = 'block';
    authPasswordInput.focus();
  });

  authBackBtn.addEventListener('click', () => {
    authOptions.style.display = 'flex';
    authPasswordForm.style.display = 'none';
    authPasswordInput.value = '';
    authError.style.display = 'none';
  });

  authSubmitBtn.addEventListener('click', () => {
    if (authPasswordInput.value === ACCESS_PASSWORD) {
      setAccessMode('pro');
    } else {
      authError.style.display = 'block';
      authPasswordInput.value = '';
      authPasswordInput.focus();
    }
  });

  authPasswordInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      authSubmitBtn.click();
    }
  });

  // Initialize
  showStep('upload', false);
</script>
