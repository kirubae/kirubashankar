---
import BaseLayout from '@layouts/BaseLayout.astro';
import { generateBreadcrumbSchema } from '@components/seo/schemas/BreadcrumbSchema';
import { generateWebApplicationSchema } from '@components/seo/schemas/WebApplicationSchema';
import Breadcrumb from '@components/ui/Breadcrumb.astro';
import Icon from '@components/ui/Icon.astro';
import '@styles/tools.css';

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'My Tools', url: '/tools' },
  { name: 'Email Validator', url: '/tools/email-validator' },
];

const jsonLdSchema = [
  generateBreadcrumbSchema(breadcrumbs),
  generateWebApplicationSchema({
    name: 'Email Validator',
    description: 'Validate email addresses in bulk. Check format and verify MX records exist.',
    slug: 'email-validator',
    category: 'UtilityApplication',
    featureList: ['Email format validation', 'MX record verification', 'Bulk processing', 'CSV/Excel support'],
  }),
];
---

<BaseLayout
  title="Mail Validity Checker - Bulk Email Verification"
  description="Validate email addresses in bulk. Check format and verify MX records. Upload CSV or Excel files, get results with validation status."
  jsonLd={jsonLdSchema}
>
  <div class="tool-container">
    <Breadcrumb items={breadcrumbs} />

    <!-- Page Heading -->
    <header class="page-header">
      <h1>Mail Validity Checker</h1>
      <p class="page-subtitle">Validate email format and MX records in bulk</p>
    </header>

    <!-- Step 1: Upload -->
    <section id="step-upload" class="step">
      <div class="step-header">
        <div class="step-badge">1</div>
        <div>
          <h2>Upload your file</h2>
          <p class="step-subtitle">CSV or Excel file with email addresses</p>
        </div>
      </div>

      <div class="upload-area" id="upload-area">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
          </svg>
        </div>
        <h2>Drop your file here</h2>
        <p>or click to browse</p>
        <button class="btn btn-primary" id="upload-btn">Choose File</button>
        <input type="file" id="file-input" accept=".csv,.xlsx,.xls" />
      </div>

      <p class="help-text">
        Supports CSV and Excel files (.xlsx, .xls). The file should have a header row with column names.
      </p>
    </section>

    <!-- Step 2: Select Column -->
    <section id="step-column" class="step" style="display: none;">
      <div class="step-header">
        <div class="step-badge">2</div>
        <div>
          <h2>Select email column</h2>
          <p class="step-subtitle">Multiple email columns detected</p>
        </div>
      </div>

      <div class="step-content">
        <div class="info-card" id="file-info">
          <p><strong>File:</strong> <span id="file-name">-</span></p>
          <p><strong>Rows:</strong> <span id="row-count">-</span></p>
        </div>

        <div class="form-section">
          <label class="form-label">Which column contains the email addresses?</label>
          <div id="column-options" class="radio-group"></div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" id="back-to-upload">Back</button>
          <button class="btn btn-primary" id="start-validation">Validate Emails</button>
        </div>
      </div>
    </section>

    <!-- Step 3: Validating -->
    <section id="step-validating" class="step" style="display: none;">
      <div class="step-header">
        <div class="step-badge">3</div>
        <div>
          <h2>Validating emails</h2>
          <p class="step-subtitle" id="validation-status">Checking format...</p>
        </div>
      </div>

      <div class="step-content">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p class="progress-text" id="progress-text">0%</p>
      </div>
    </section>

    <!-- Step 4: Results -->
    <section id="step-results" class="step" style="display: none;">
      <div class="step-header">
        <div class="step-badge">4</div>
        <div>
          <h2>Validation complete</h2>
          <p class="step-subtitle">Results are ready</p>
        </div>
      </div>

      <!-- Summary -->
      <div class="summary-cards" id="summary-cards">
        <div class="summary-card">
          <span class="summary-value" id="total-count">0</span>
          <span class="summary-label">Total</span>
        </div>
        <div class="summary-card valid">
          <span class="summary-value" id="valid-count">0</span>
          <span class="summary-label">Valid</span>
        </div>
        <div class="summary-card invalid">
          <span class="summary-value" id="invalid-format-count">0</span>
          <span class="summary-label">Invalid Format</span>
        </div>
        <div class="summary-card warning">
          <span class="summary-value" id="no-mx-count">0</span>
          <span class="summary-label">No MX Record</span>
        </div>
      </div>

      <!-- Results Table -->
      <div class="results-table-wrapper">
        <table id="results-table">
          <thead id="results-header"></thead>
          <tbody id="results-body"></tbody>
        </table>
      </div>

      <div class="action-bar">
        <button class="btn btn-secondary" id="start-over">Start Over</button>
        <button class="btn btn-primary" id="download-results">Download CSV</button>
      </div>
    </section>
  </div>
</BaseLayout>

<style is:global>
  /* Page-specific styles */
  #file-input {
    display: none;
  }

  .summary-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .summary-card {
    background: var(--color-cream);
    padding: 20px;
    border-radius: 8px;
    text-align: center;
  }

  .summary-card.valid {
    background: #ecfdf5;
  }

  .summary-card.invalid {
    background: #fef2f2;
  }

  .summary-card.warning {
    background: #fffbeb;
  }

  .summary-value {
    display: block;
    font-size: 32px;
    font-weight: 700;
    color: var(--color-ink);
    margin-bottom: 4px;
  }

  .summary-card.valid .summary-value {
    color: #059669;
  }

  .summary-card.invalid .summary-value {
    color: #dc2626;
  }

  .summary-card.warning .summary-value {
    color: #d97706;
  }

  .summary-label {
    font-size: 13px;
    color: var(--color-ink-light);
  }

  #results-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  #results-table th,
  #results-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  #results-table th {
    background: var(--color-cream);
    font-weight: 600;
    position: sticky;
    top: 0;
  }

  #results-table tr:hover td {
    background: var(--color-cream);
  }

  .status-valid {
    color: #059669;
    font-weight: 500;
  }

  .status-invalid {
    color: #dc2626;
    font-weight: 500;
  }

  .status-warning {
    color: #d97706;
    font-weight: 500;
  }

  @media (max-width: 640px) {
    .summary-cards {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<!-- SheetJS for Excel parsing -->
<script is:inline src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<script is:inline>
  // State
  let currentFile = null;
  let r2Key = null;
  let selectedColumnName = null;
  let jobId = null;
  let resultKey = null;
  let jobStats = null;

  // DOM Elements
  const elements = {
    uploadArea: document.getElementById('upload-area'),
    fileInput: document.getElementById('file-input'),
    uploadBtn: document.getElementById('upload-btn'),
    stepUpload: document.getElementById('step-upload'),
    stepColumn: document.getElementById('step-column'),
    stepValidating: document.getElementById('step-validating'),
    stepResults: document.getElementById('step-results'),
    fileName: document.getElementById('file-name'),
    rowCount: document.getElementById('row-count'),
    columnOptions: document.getElementById('column-options'),
    backToUpload: document.getElementById('back-to-upload'),
    startValidation: document.getElementById('start-validation'),
    validationStatus: document.getElementById('validation-status'),
    progressFill: document.getElementById('progress-fill'),
    progressText: document.getElementById('progress-text'),
    totalCount: document.getElementById('total-count'),
    validCount: document.getElementById('valid-count'),
    invalidFormatCount: document.getElementById('invalid-format-count'),
    noMxCount: document.getElementById('no-mx-count'),
    resultsHeader: document.getElementById('results-header'),
    resultsBody: document.getElementById('results-body'),
    startOver: document.getElementById('start-over'),
    downloadResults: document.getElementById('download-results'),
  };

  // Email validation regex
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  // Show step
  function showStep(step) {
    elements.stepUpload.style.display = 'none';
    elements.stepColumn.style.display = 'none';
    elements.stepValidating.style.display = 'none';
    elements.stepResults.style.display = 'none';

    if (step === 'upload') elements.stepUpload.style.display = 'block';
    if (step === 'column') elements.stepColumn.style.display = 'block';
    if (step === 'validating') elements.stepValidating.style.display = 'block';
    if (step === 'results') elements.stepResults.style.display = 'block';
  }

  // Update progress
  function updateProgress(percent, message) {
    elements.progressFill.style.width = `${percent}%`;
    elements.progressText.textContent = `${percent}%`;
    if (message) elements.validationStatus.textContent = message;
  }

  // Upload file with progress tracking using XMLHttpRequest
  function uploadFileWithProgress(file, onProgress) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      const formData = new FormData();
      formData.append('file', file);

      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          onProgress(percent);
        }
      });

      xhr.addEventListener('load', () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            resolve(JSON.parse(xhr.responseText));
          } catch {
            reject(new Error('Invalid response from server'));
          }
        } else {
          try {
            const err = JSON.parse(xhr.responseText);
            reject(new Error(err.error || `Upload failed: ${xhr.status}`));
          } catch {
            reject(new Error(`Upload failed: ${xhr.status}`));
          }
        }
      });

      xhr.addEventListener('error', () => reject(new Error('Network error during upload')));
      xhr.addEventListener('abort', () => reject(new Error('Upload cancelled')));

      xhr.open('POST', '/api/email/upload');
      xhr.send(formData);
    });
  }

  // Handle file selection
  async function handleFile(file) {
    if (!file) return;
    currentFile = file;

    try {
      showStep('validating');
      updateProgress(0, 'Uploading file...');

      // Step 1: Upload file to R2 with progress tracking
      const uploadResult = await uploadFileWithProgress(file, (percent) => {
        // Scale upload progress to 0-25%
        const scaledPercent = Math.round(percent * 0.25);
        updateProgress(scaledPercent, `Uploading file... ${percent}%`);
      });

      r2Key = uploadResult.key;

      updateProgress(30, 'Analyzing file...');

      // Step 2: Preview file to get columns via CF Pages API
      const previewRes = await fetch('/api/email/preview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key: r2Key }),
      });

      if (!previewRes.ok) {
        const err = await previewRes.json().catch(() => ({}));
        throw new Error(err.error || 'Failed to preview file');
      }

      const preview = await previewRes.json();

      elements.fileName.textContent = file.name;
      elements.rowCount.textContent = preview.rowCount.toLocaleString();

      // Detect email columns
      const emailColumns = preview.columns.filter(col => {
        const lower = col.toLowerCase();
        return lower.includes('email') || lower.includes('e-mail');
      });

      // If no email-like column names, show all columns
      const columnsToShow = emailColumns.length > 0 ? emailColumns : preview.columns;

      if (columnsToShow.length === 1) {
        selectedColumnName = columnsToShow[0];
        startValidationJob();
      } else {
        // Show column selection
        elements.columnOptions.innerHTML = columnsToShow
          .map((col, i) => `
            <label class="radio-card">
              <input type="radio" name="email-column" value="${col}" ${i === 0 ? 'checked' : ''}>
              <div class="radio-content">
                <span class="radio-icon">@</span>
                <span>${col}</span>
              </div>
            </label>
          `)
          .join('');
        showStep('column');
      }

    } catch (error) {
      console.error('Error handling file:', error);
      alert('Error: ' + error.message);
      showStep('upload');
    }
  }

  // Start validation job on DO backend
  async function startValidationJob() {
    showStep('validating');
    updateProgress(30, 'Validating emails...');

    try {
      // Create job via CF Pages proxy (proxies to DO backend with Python dnspython)
      // The endpoint now processes synchronously and returns results directly
      const jobRes = await fetch('/api/email/jobs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          r2_key: r2Key,
          email_column: selectedColumnName,
        }),
      });

      if (!jobRes.ok) {
        const err = await jobRes.json().catch(() => ({}));
        throw new Error(err.detail || err.error || 'Failed to validate emails');
      }

      const result = await jobRes.json();

      // Handle synchronous response (new flow)
      if (result.status === 'completed') {
        jobId = result.jobId;
        jobStats = result.stats;
        resultKey = result.result_key;
        updateProgress(100, 'Validation complete');
        showResults();
      } else if (result.jobId && !result.status) {
        // Legacy async flow (fallback)
        jobId = result.jobId;
        pollJobStatus();
      } else {
        throw new Error('Unexpected response from server');
      }

    } catch (error) {
      console.error('Error starting job:', error);
      alert('Error: ' + error.message);
      showStep('upload');
    }
  }

  // Poll job status (fallback for legacy async flow)
  async function pollJobStatus() {
    try {
      const res = await fetch(`/api/email/jobs/${jobId}`);
      if (!res.ok) throw new Error('Failed to get job status');

      const status = await res.json();
      updateProgress(status.progress, status.message);

      if (status.status === 'completed') {
        jobStats = status.stats;
        resultKey = status.result_key;
        showResults();
      } else if (status.status === 'failed') {
        alert('Validation failed: ' + status.message);
        showStep('upload');
      } else {
        // Continue polling
        setTimeout(pollJobStatus, 1000);
      }

    } catch (error) {
      console.error('Error polling status:', error);
      setTimeout(pollJobStatus, 2000);
    }
  }

  // Show results
  function showResults() {
    showStep('results');

    if (jobStats) {
      elements.totalCount.textContent = jobStats.total.toLocaleString();
      elements.validCount.textContent = jobStats.valid.toLocaleString();
      elements.invalidFormatCount.textContent = jobStats.invalid_format.toLocaleString();
      elements.noMxCount.textContent = jobStats.no_mx.toLocaleString();
    }

    // Show simple message instead of table (results are in downloaded file)
    elements.resultsHeader.innerHTML = '';
    elements.resultsBody.innerHTML = `
      <tr>
        <td style="text-align: center; padding: 40px; color: var(--color-ink-light);">
          <p style="margin-bottom: 8px;">Results are ready for download.</p>
          <p>Click "Download CSV" to get the full results with validation status for each email.</p>
        </td>
      </tr>
    `;
  }

  // Download results
  function downloadResults() {
    if (!resultKey) {
      alert('Download not available. Please try again.');
      return;
    }

    // Download directly from CF Pages proxy (which proxies to DO backend)
    window.open(`/api/email/download/${encodeURIComponent(resultKey)}`, '_blank');
  }

  // Reset
  function reset() {
    currentFile = null;
    r2Key = null;
    selectedColumnName = null;
    jobId = null;
    resultKey = null;
    jobStats = null;
    elements.fileInput.value = '';
    elements.progressFill.style.width = '0%';
    elements.progressText.textContent = '0%';
    showStep('upload');
  }

  // Event Listeners
  elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
  elements.uploadArea.addEventListener('click', (e) => {
    if (e.target !== elements.uploadBtn) elements.fileInput.click();
  });

  elements.fileInput.addEventListener('change', (e) => {
    handleFile(e.target.files[0]);
  });

  elements.uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    elements.uploadArea.classList.add('dragover');
  });

  elements.uploadArea.addEventListener('dragleave', () => {
    elements.uploadArea.classList.remove('dragover');
  });

  elements.uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    elements.uploadArea.classList.remove('dragover');
    handleFile(e.dataTransfer.files[0]);
  });

  elements.backToUpload.addEventListener('click', reset);

  elements.startValidation.addEventListener('click', () => {
    const selected = document.querySelector('input[name="email-column"]:checked');
    if (selected) {
      selectedColumnName = selected.value;
      startValidationJob();
    }
  });

  elements.startOver.addEventListener('click', reset);
  elements.downloadResults.addEventListener('click', downloadResults);
</script>
